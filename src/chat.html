<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style type="text/css">
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #0c1317;
            color: #e9edef;
            height: 100vh;
            overflow: hidden;
        }

        .whatsapp-container {
            display: flex;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
            background: #0c1317;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 480px;
            min-width: 380px;
            background: #111b21;
            border-right: 1px solid #222d34;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .sidebar-header {
            background: #202c33;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            border-bottom: 1px solid #222d34;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .profile-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00a884, #53bdeb);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 18px;
        }

        .profile-name {
            font-weight: 500;
            font-size: 16px;
        }

        .sidebar-actions {
            display: flex;
            gap: 20px;
            color: #aebac1;
        }

        .sidebar-actions i {
            font-size: 20px;
            cursor: pointer;
        }

        /* Chat Main Area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        .chat-header {
            background: #202c33;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            border-bottom: 1px solid #222d34;
        }

        .chat-partner {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .partner-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00a884, #53bdeb);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 18px;
        }

        .chat-actions {
            display: flex;
            gap: 20px;
            color: #aebac1;
        }

        .chat-actions i {
            font-size: 20px;
            cursor: pointer;
        }

        /* Messages Container */
        .messages-container {
            flex: 1;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%2314222c' fill-opacity='0.4' fill-rule='evenodd'/%3E%3C/svg%3E");
            background-color: #0c1317;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Message Styles */
        .message {
            max-width: 65%;
            margin-bottom: 10px;
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.incoming {
            align-self: flex-start;
        }

        .message.outgoing {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            margin-top: 4px;
            margin-right: 8px;
            background: linear-gradient(135deg, #00a884, #53bdeb);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .message.outgoing .message-avatar {
            margin-right: 0;
            margin-left: 8px;
        }

        .message-content {
            position: relative;
        }

        .message-bubble {
            padding: 8px 12px;
            border-radius: 7.5px;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
            max-width: 100%;
            box-shadow: 0 1px 0.5px rgba(11, 20, 26, 0.13);
        }

        .message.incoming .message-bubble {
            background: #202c33;
            border-top-left-radius: 0;
        }

        .message.outgoing .message-bubble {
            background: #005c4b;
            border-top-right-radius: 0;
            color: #e9edef;
        }

        .message-info {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
            font-size: 11px;
            color: #ffffff99;
        }

        .message.incoming .message-info {
            justify-content: flex-start;
            color: #8696a0;
        }

        .message-time {
            font-size: 11px;
        }

        /* System Messages */
        .system-message {
            align-self: center;
            background: rgba(134, 150, 160, 0.15);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12.5px;
            color: #8696a0;
            margin: 10px 0;
            max-width: 80%;
            text-align: center;
        }

        .system-message.join {
            color: #00a884;
        }

        .system-message.leave {
            color: #ff6b6b;
        }

        /* Input Area */
        .input-container {
            background: #202c33;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            min-height: 62px;
        }

        .input-actions {
            display: flex;
            gap: 15px;
            color: #8696a0;
        }

        .input-actions i {
            font-size: 24px;
            cursor: pointer;
        }

        .message-input {
            flex: 1;
            background: #2a3942;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            color: #e9edef;
            font-size: 15px;
            outline: none;
            resize: none;
            max-height: 100px;
            min-height: 40px;
            line-height: 1.4;
            font-family: inherit;
        }

        .message-input::placeholder {
            color: #8696a0;
        }

        .send-button {
            background: #00a884;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .send-button:hover {
            background: #06cf9c;
        }

        .send-button i {
            font-size: 18px;
        }

        .send-button:disabled {
            background: #2a3942;
            color: #8696a0;
            cursor: not-allowed;
        }

        /* Login/Setup Screens */
        .setup-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0c1317;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .setup-container {
            background: #202c33;
            padding: 40px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .setup-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #00a884, #53bdeb);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
        }

        .setup-icon i {
            font-size: 50px;
            color: white;
        }

        .setup-input {
            width: 100%;
            padding: 12px 16px;
            background: #2a3942;
            border: 1px solid #222d34;
            border-radius: 8px;
            color: #e9edef;
            font-size: 16px;
            margin-bottom: 15px;
            text-align: center;
        }

        .setup-button {
            width: 100%;
            padding: 14px;
            background: #00a884;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .setup-button:hover {
            background: #06cf9c;
        }

        .setup-button.secondary {
            background: #2a3942;
            margin-top: 10px;
        }

        .setup-button.secondary:hover {
            background: #374045;
        }

        /* Online Users Side Panel */
        .users-panel {
            width: 280px;
            background: #111b21;
            border-left: 1px solid #222d34;
            padding: 20px;
            overflow-y: auto;
            display: none;
        }

        .users-panel.active {
            display: block;
        }

        .users-header {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 20px;
            color: #00a884;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #202c33;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00a884, #53bdeb);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .user-name {
            font-weight: 500;
        }

        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00a884;
            margin-left: auto;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #374045;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4a5c65;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .sidebar {
                width: 380px;
                min-width: 320px;
            }
            
            .users-panel {
                position: fixed;
                right: 0;
                top: 0;
                height: 100%;
                z-index: 100;
            }
        }

        @media (max-width: 768px) {
            .whatsapp-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 40%;
                border-right: none;
                border-bottom: 1px solid #222d34;
            }
            
            .chat-main {
                height: 60%;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Setup Screen -->
    <div id="setup-screen" class="setup-screen">
        <div class="setup-container">
            <div class="setup-icon">
                <i class="fas fa-comments"></i>
            </div>
            <h2 style="margin-bottom: 30px; color: #e9edef;">Durable Objects Chat</h2>
            
            <div id="name-setup">
                <input type="text" id="username-input" class="setup-input" placeholder="Enter your name" maxlength="32" autocomplete="off">
                <button id="continue-btn" class="setup-button">Continue</button>
            </div>
            
            <div id="room-setup" style="display: none;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button id="public-room-btn" class="setup-button secondary">
                        <i class="fas fa-globe"></i> Public Room
                    </button>
                    <button id="private-room-btn" class="setup-button secondary">
                        <i class="fas fa-lock"></i> Private Room
                    </button>
                </div>
                
                <div id="room-name-container" style="display: none;">
                    <input type="text" id="room-name-input" class="setup-input" placeholder="Enter room name" maxlength="32" autocomplete="off">
                    <button id="join-room-btn" class="setup-button">Join Room</button>
                    <button id="back-to-name" class="setup-button secondary" style="margin-top: 10px;">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="whatsapp-container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-profile">
                    <div class="profile-avatar" id="user-avatar">U</div>
                    <div class="profile-name" id="user-name">User</div>
                </div>
                <div class="sidebar-actions">
                    <i class="fas fa-users" id="toggle-users-panel" title="Online Users"></i>
                    <i class="fas fa-cog" id="settings-btn" title="Settings"></i>
                </div>
            </div>
            
            <div style="padding: 20px; color: #8696a0; font-size: 14px;">
                <div style="margin-bottom: 10px;">
                    <i class="fas fa-door-open"></i> Room: <span id="sidebar-room-name">Not connected</span>
                </div>
                <div>
                    <i class="fas fa-users"></i> Online: <span id="sidebar-user-count">0</span> users
                </div>
            </div>
            
            <div style="padding: 20px; border-top: 1px solid #222d34; margin-top: auto;">
                <button id="leave-room-btn" class="setup-button secondary" style="width: 100%;">
                    <i class="fas fa-sign-out-alt"></i> Leave Room
                </button>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main">
            <div class="chat-header">
                <div class="chat-partner">
                    <div class="partner-avatar" id="room-avatar">R</div>
                    <div>
                        <h3 id="room-title">Durable Objects Chat</h3>
                        <p id="room-status">Connecting...</p>
                    </div>
                </div>
                <div class="chat-actions">
                    <i class="fas fa-info-circle" title="Room Info"></i>
                    <i class="fas fa-ellipsis-v" title="Menu"></i>
                </div>
            </div>

            <div class="messages-container" id="messages-container">
                <!-- Messages will be loaded here -->
            </div>

            <div class="input-container">
                <div class="input-actions">
                    <i class="far fa-smile" id="emoji-btn" title="Emoji"></i>
                </div>
                <textarea class="message-input" id="message-input" placeholder="Type a message" disabled></textarea>
                <button class="send-button" id="send-button" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- Online Users Panel -->
        <div class="users-panel" id="users-panel">
            <div class="users-header">
                <i class="fas fa-users"></i> Online Users
                <span style="margin-left: auto; font-size: 14px; color: #8696a0;" id="online-count">0</span>
            </div>
            <div id="users-list">
                <!-- Users will be listed here -->
            </div>
        </div>
    </div>

    <script>
        // Durable Objects Chat Client
        class DurableObjectsChat {
            constructor() {
                this.ws = null;
                this.username = '';
                this.roomName = '';
                this.roomId = '';
                this.isPrivateRoom = false;
                this.onlineUsers = new Map();
                this.messageQueue = [];
                this.isConnected = false;
                
                // DOM Elements
                this.setupScreen = document.getElementById('setup-screen');
                this.appContainer = document.querySelector('.whatsapp-container');
                this.usernameInput = document.getElementById('username-input');
                this.continueBtn = document.getElementById('continue-btn');
                this.publicRoomBtn = document.getElementById('public-room-btn');
                this.privateRoomBtn = document.getElementById('private-room-btn');
                this.roomNameContainer = document.getElementById('room-name-container');
                this.roomNameInput = document.getElementById('room-name-input');
                this.joinRoomBtn = document.getElementById('join-room-btn');
                this.backToNameBtn = document.getElementById('back-to-name');
                
                this.userAvatar = document.getElementById('user-avatar');
                this.userName = document.getElementById('user-name');
                this.sidebarRoomName = document.getElementById('sidebar-room-name');
                this.sidebarUserCount = document.getElementById('sidebar-user-count');
                this.roomAvatar = document.getElementById('room-avatar');
                this.roomTitle = document.getElementById('room-title');
                this.roomStatus = document.getElementById('room-status');
                this.messagesContainer = document.getElementById('messages-container');
                this.messageInput = document.getElementById('message-input');
                this.sendButton = document.getElementById('send-button');
                this.leaveRoomBtn = document.getElementById('leave-room-btn');
                this.toggleUsersPanel = document.getElementById('toggle-users-panel');
                this.usersPanel = document.getElementById('users-panel');
                this.usersList = document.getElementById('users-list');
                this.onlineCount = document.getElementById('online-count');
                
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.checkUrlHash();
            }
            
            bindEvents() {
                // Setup events
                this.continueBtn.addEventListener('click', () => this.setupUsername());
                this.usernameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.setupUsername();
                });
                
                this.publicRoomBtn.addEventListener('click', () => this.showRoomNameInput(false));
                this.privateRoomBtn.addEventListener('click', () => this.createPrivateRoom());
                this.joinRoomBtn.addEventListener('click', () => this.joinPublicRoom());
                this.roomNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.joinPublicRoom();
                });
                this.backToNameBtn.addEventListener('click', () => this.backToNameSetup());
                
                // Chat events
                this.messageInput.addEventListener('input', () => this.handleInputChange());
                this.messageInput.addEventListener('keydown', (e) => this.handleKeyDown(e));
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.leaveRoomBtn.addEventListener('click', () => this.leaveRoom());
                this.toggleUsersPanel.addEventListener('click', () => this.toggleUsersPanelView());
                
                // Auto-focus username input
                this.usernameInput.focus();
            }
            
            checkUrlHash() {
                const hash = window.location.hash.substring(1);
                if (hash) {
                    // If URL has a room hash, parse it
                    const parts = hash.split(':');
                    if (parts.length === 2) {
                        this.roomId = parts[0];
                        this.roomName = decodeURIComponent(parts[1]);
                        this.isPrivateRoom = this.roomId.length === 64;
                        document.getElementById('name-setup').style.display = 'none';
                        document.getElementById('room-setup').style.display = 'block';
                        this.usernameInput.focus();
                    }
                }
            }
            
            setupUsername() {
                const username = this.usernameInput.value.trim();
                if (!username) {
                    alert('Please enter your name');
                    return;
                }
                
                if (username.length > 32) {
                    alert('Name must be 32 characters or less');
                    return;
                }
                
                this.username = username;
                this.userAvatar.textContent = username.charAt(0).toUpperCase();
                this.userName.textContent = username;
                
                document.getElementById('name-setup').style.display = 'none';
                document.getElementById('room-setup').style.display = 'block';
                
                // If room ID already set from URL hash, join directly
                if (this.roomId) {
                    this.joinRoom();
                } else {
                    this.roomNameInput.focus();
                }
            }
            
            showRoomNameInput(isPrivate) {
                this.isPrivateRoom = isPrivate;
                this.roomNameContainer.style.display = 'block';
                if (!isPrivate) {
                    this.roomNameInput.focus();
                } else {
                    this.createPrivateRoom();
                }
            }
            
            async createPrivateRoom() {
                try {
                    const response = await fetch('/api/room', { method: 'POST' });
                    if (!response.ok) throw new Error('Failed to create private room');
                    
                    this.roomId = await response.text();
                    this.roomName = 'Private Room';
                    this.joinRoom();
                } catch (error) {
                    console.error('Error creating private room:', error);
                    alert('Failed to create private room. Please try again.');
                }
            }
            
            joinPublicRoom() {
                const roomName = this.roomNameInput.value.trim();
                if (!roomName) {
                    alert('Please enter a room name');
                    return;
                }
                
                if (roomName.length > 32) {
                    alert('Room name must be 32 characters or less');
                    return;
                }
                
                // Normalize room name (same as backend)
                this.roomName = roomName.replace(/[^a-zA-Z0-9_-]/g, '').replace(/_/g, '-').toLowerCase();
                this.roomId = this.roomName;
                this.joinRoom();
            }
            
            backToNameSetup() {
                document.getElementById('name-setup').style.display = 'block';
                document.getElementById('room-setup').style.display = 'none';
                this.roomNameContainer.style.display = 'none';
                this.usernameInput.focus();
            }
            
            joinRoom() {
                // Update UI
                this.setupScreen.style.display = 'none';
                this.appContainer.style.display = 'flex';
                
                this.roomAvatar.textContent = this.roomName.charAt(0).toUpperCase();
                this.roomTitle.textContent = this.roomName;
                this.sidebarRoomName.textContent = this.roomName;
                this.roomStatus.textContent = 'Connecting...';
                
                // Update URL
                const roomInfo = `${this.roomId}:${encodeURIComponent(this.roomName)}`;
                window.location.hash = roomInfo;
                
                // Connect WebSocket
                this.connectWebSocket();
            }
            
            connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const hostname = window.location.host || 'localhost:8787'; // Default to wrangler port
                const wsUrl = `${protocol}//${hostname}/api/room/${this.roomId}/websocket`;
                
                console.log('Connecting to:', wsUrl);
                
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('WebSocket connected');
                    this.isConnected = true;
                    this.roomStatus.textContent = 'Connected';
                    this.messageInput.disabled = false;
                    this.messageInput.placeholder = 'Type a message...';
                    this.messageInput.focus();
                    
                    // Send user info
                    this.ws.send(JSON.stringify({ name: this.username }));
                };
                
                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleMessage(data);
                    } catch (error) {
                        console.error('Error parsing message:', error, event.data);
                    }
                };
                
                this.ws.onclose = (event) => {
                    console.log('WebSocket disconnected:', event.code, event.reason);
                    this.isConnected = false;
                    this.roomStatus.textContent = 'Disconnected - Reconnecting...';
                    this.messageInput.disabled = true;
                    this.messageInput.placeholder = 'Disconnected...';
                    this.sendButton.disabled = true;
                    
                    // Clear online users
                    this.onlineUsers.clear();
                    this.updateUsersList();
                    
                    // Reconnect after delay
                    setTimeout(() => this.connectWebSocket(), 3000);
                };
                
                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.roomStatus.textContent = 'Connection error';
                };
            }
            
            handleMessage(data) {
                if (data.error) {
                    this.addSystemMessage(`Error: ${data.error}`, 'error');
                } else if (data.joined) {
                    this.addSystemMessage(`${data.joined} joined the chat`, 'join');
                    this.onlineUsers.set(data.joined, { name: data.joined });
                    this.updateUsersList();
                } else if (data.quit) {
                    this.addSystemMessage(`${data.quit} left the chat`, 'leave');
                    this.onlineUsers.delete(data.quit);
                    this.updateUsersList();
                } else if (data.ready) {
                    this.addSystemMessage('Welcome to the chat! Type /help for commands.', 'info');
                    this.messageQueue.forEach(msg => this.ws.send(msg));
                    this.messageQueue = [];
                } else if (data.name && data.message) {
                    const isOwnMessage = data.name === this.username;
                    this.addChatMessage(data.name, data.message, isOwnMessage, data.timestamp);
                }
            }
            
            handleInputChange() {
                const text = this.messageInput.value.trim();
                this.sendButton.disabled = !text || !this.isConnected;
                
                // Auto-resize textarea
                this.messageInput.style.height = 'auto';
                this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 100) + 'px';
            }
            
            handleKeyDown(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            }
            
            sendMessage() {
                const text = this.messageInput.value.trim();
                if (!text || !this.isConnected || !this.ws) return;
                
                // Add to UI immediately
                this.addChatMessage(this.username, text, true, Date.now());
                
                // Send via WebSocket
                if (this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ message: text }));
                } else {
                    // Queue message if not connected
                    this.messageQueue.push(JSON.stringify({ message: text }));
                    this.addSystemMessage('Message queued (reconnecting...)', 'info');
                }
                
                // Clear input
                this.messageInput.value = '';
                this.messageInput.style.height = 'auto';
                this.sendButton.disabled = true;
                
                // Scroll to bottom
                this.scrollToBottom();
            }
            
            addChatMessage(sender, text, isOwn, timestamp) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isOwn ? 'outgoing' : 'incoming'}`;
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = sender.charAt(0).toUpperCase();
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.textContent = text;
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'message-info';
                
                const timeSpan = document.createElement('span');
                timeSpan.className = 'message-time';
                const date = new Date(timestamp);
                timeSpan.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                infoDiv.appendChild(timeSpan);
                
                contentDiv.appendChild(bubble);
                contentDiv.appendChild(infoDiv);
                
                if (!isOwn) {
                    messageDiv.appendChild(avatar);
                }
                messageDiv.appendChild(contentDiv);
                if (isOwn) {
                    messageDiv.appendChild(avatar);
                }
                
                this.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }
            
            addSystemMessage(text, type = 'info') {
                const systemDiv = document.createElement('div');
                systemDiv.className = `system-message ${type}`;
                systemDiv.textContent = text;
                this.messagesContainer.appendChild(systemDiv);
                this.scrollToBottom();
            }
            
            updateUsersList() {
                // Update sidebar count
                const totalUsers = this.onlineUsers.size + 1; // +1 for current user
                this.sidebarUserCount.textContent = totalUsers;
                this.onlineCount.textContent = totalUsers;
                
                // Update users list
                this.usersList.innerHTML = '';
                
                // Add current user first
                const currentUserItem = document.createElement('div');
                currentUserItem.className = 'user-item';
                currentUserItem.innerHTML = `
                    <div class="user-avatar">${this.username.charAt(0).toUpperCase()}</div>
                    <div class="user-name">${this.username} (You)</div>
                    <div class="user-status" style="background: #00a884;"></div>
                `;
                this.usersList.appendChild(currentUserItem);
                
                // Add other users
                this.onlineUsers.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    userItem.innerHTML = `
                        <div class="user-avatar">${user.name.charAt(0).toUpperCase()}</div>
                        <div class="user-name">${user.name}</div>
                        <div class="user-status"></div>
                    `;
                    this.usersList.appendChild(userItem);
                });
            }
            
            toggleUsersPanelView() {
                this.usersPanel.classList.toggle('active');
            }
            
            leaveRoom() {
                if (this.ws) {
                    this.ws.close();
                }
                
                // Reset state
                this.roomName = '';
                this.roomId = '';
                this.isPrivateRoom = false;
                this.onlineUsers.clear();
                this.messageQueue = [];
                this.isConnected = false;
                
                // Reset UI
                this.messagesContainer.innerHTML = '';
                this.messageInput.value = '';
                this.messageInput.disabled = true;
                this.sendButton.disabled = true;
                
                // Show setup screen
                this.appContainer.style.display = 'none';
                this.setupScreen.style.display = 'flex';
                
                // Reset to name input
                document.getElementById('name-setup').style.display = 'block';
                document.getElementById('room-setup').style.display = 'none';
                document.getElementById('room-name-container').style.display = 'none';
                this.usernameInput.value = '';
                this.usernameInput.focus();
                
                // Clear URL hash
                window.location.hash = '';
            }
            
            scrollToBottom() {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }
        }
        
        // Initialize chat when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.chatApp = new DurableObjectsChat();
        });
    </script>
</body>
</html>
