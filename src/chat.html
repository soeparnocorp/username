<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Edge Chat</title>

<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background: var(--bg);
  color: var(--fg);
}

:root {
  --bg: #f0f2f5;
  --fg: #111;
  --panel: #ffffff;
  --border: #ddd;
}
body.dark {
  --bg: #111b21;
  --fg: #e9edef;
  --panel: #202c33;
  --border: #2a3942;
}

/* ===== Layout ===== */
#app {
  display: flex;
  height: 100vh;
}

/* ===== Sidebar ===== */
#sidebar {
  width: 320px;
  background: var(--panel);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
}

#sidebar-header {
  position: sticky;
  top: 0;
  padding: 10px;
  display: flex;
  gap: 8px;
  align-items: center;
  border-bottom: 1px solid var(--border);
  background: var(--panel);
  z-index: 2;
}

#room-name {
  flex: 1;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
  outline: none;
}

#menu {
  cursor: pointer;
  padding: 6px 8px;
  user-select: none;
}

#menu-popup {
  position: absolute;
  top: 50px;
  right: 10px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 6px;
  display: none;
}
#menu-popup button {
  background: none;
  border: none;
  padding: 10px 14px;
  width: 100%;
  text-align: left;
  color: var(--fg);
}

#roster {
  padding: 10px;
  overflow-y: auto;
  flex: 1;
  font-weight: bold;
}

/* ===== Chat ===== */
#chat {
  flex: 1;
  display: flex;
  flex-direction: column;
}

#chatlog {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
}

#chatlog p { margin: 0 0 8px; }
.username { font-weight: bold; }

#chat-input {
  border: none;
  border-top: 1px solid var(--border);
  padding: 12px;
  font-size: 16px;
  outline: none;
  background: var(--panel);
  color: var(--fg);
}

/* ===== Mobile ===== */
@media (max-width: 700px) {
  #sidebar { width: 100%; }
  #chat { display: none; }
  body.in-chat #sidebar { display: none; }
  body.in-chat #chat { display: flex; }
}
</style>
</head>

<body>
<div id="app">
  <!-- SIDEBAR -->
  <div id="sidebar">
    <div id="sidebar-header">
      <form id="room-form" style="display:flex;flex:1;gap:8px">
        <input id="room-name" placeholder="Search or create room" />
      </form>
      <div id="menu">â‹®</div>
      <div id="menu-popup">
        <button id="toggle-theme">Toggle Day / Night</button>
      </div>
    </div>
    <div id="roster"></div>
  </div>

  <!-- CHAT -->
  <form id="chat" action="/fake">
    <div id="chatlog"></div>
    <input id="chat-input" placeholder="Type a message" />
  </form>
</div>

<script>
let ws = null;
let username = null;
let roomname = null;
let isAtBottom = true;

const roster = document.getElementById("roster");
const chatlog = document.getElementById("chatlog");
const chatInput = document.getElementById("chat-input");
const roomInput = document.getElementById("room-name");
const roomForm = document.getElementById("room-form");

const hostname = location.host || "localhost:8787";

/* ===== Menu ===== */
const menu = document.getElementById("menu");
const popup = document.getElementById("menu-popup");
menu.onclick = () => popup.style.display = popup.style.display === "block" ? "none" : "block";
document.getElementById("toggle-theme").onclick = () => {
  document.body.classList.toggle("dark");
  popup.style.display = "none";
};

/* ===== Room handling ===== */
roomForm.addEventListener("submit", e => {
  e.preventDefault();
  roomname = roomInput.value;
  if (roomname) startChat();
});

function startChat() {
  roomname = roomname.replace(/[^a-zA-Z0-9_-]/g, "").toLowerCase();
  location.hash = "#" + roomname;
  document.body.classList.add("in-chat");
  connect();
}

/* ===== Chat ===== */
function connect() {
  const proto = location.protocol === "http:" ? "ws://" : "wss://";
  ws = new WebSocket(proto + hostname + "/api/room/" + roomname + "/websocket");

  ws.onopen = () => {
    if (!username) {
      username = prompt("Your name?");
    }
    ws.send(JSON.stringify({ name: username }));
  };

  ws.onmessage = e => {
    const data = JSON.parse(e.data);
    if (data.joined) {
      roster.appendChild(Object.assign(document.createElement("p"), { innerText: data.joined }));
    } else if (data.quit) {
      [...roster.children].forEach(p => p.innerText === data.quit && p.remove());
    } else if (data.message) {
      addMessage(data.name, data.message);
    }
  };

  ws.onclose = () => setTimeout(connect, 1000);
}

document.getElementById("chat").addEventListener("submit", e => {
  e.preventDefault();
  if (ws && chatInput.value) {
    ws.send(JSON.stringify({ message: chatInput.value }));
    chatInput.value = "";
    chatlog.scrollTop = 1e9;
  }
});

function addMessage(name, text) {
  const p = document.createElement("p");
  if (name) {
    const u = document.createElement("span");
    u.className = "username";
    u.innerText = name + ": ";
    p.appendChild(u);
  }
  p.appendChild(document.createTextNode(text));
  chatlog.appendChild(p);
  if (isAtBottom) chatlog.scrollTop = 1e9;
}

if (location.hash.length > 1) {
  roomInput.value = location.hash.slice(1);
  startChat();
}
</script>
</body>
</html>
